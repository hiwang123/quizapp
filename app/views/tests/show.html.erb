<div class='container'>
  <h2 class="test-title"><%= @test.title %></h2>
  <div class="panel with-nav-tabs panel-default">
	<div class="panel-heading">
	  <ul class="nav nav-tabs">
		<li>
		  <a href='#1a' data-toggle='tab'>測驗</a>
		</li>
		<li class='active'>
		  <a href='#2a' data-toggle='tab'>分析</a>
		</li>
		<li>
		  <a href='#3a' data-toggle='tab'>瀏覽</a>
		</li>
	  </ul>
	</div>

	<div class='panel-body'>
	 <div class='tab-content'>
	  <div class='tab-pane fade' id='1a'>
		<div id='show1'>
		  <h4>試題</h4>
		  <pre id='prob'></pre> 
		  <img id='img'>
		  <h4>作答</h4>
		  <div id='fill'>
			  <input type='text'>
		  </div>
		  <div id='choice'>
			<label class="checkbox-inline"><input type='checkbox' value='a'>A</label>
			<label class="checkbox-inline"><input type='checkbox' value='b'>B</label>
			<label class="checkbox-inline"><input type='checkbox' value='c'>C</label>
			<label class="checkbox-inline"><input type='checkbox' value='d'>D</label>
			<label class="checkbox-inline"><input type='checkbox' value='e'>E</label>
		  </div>
		</div>
		<div id='show2'>
		  <h4>結果</h4> 
		  <pre id='result'></pre>
		  <h4>答案</h4>
		  <pre id='ans'></pre>
		  <h4>詳解</h4>
		  <pre id='explain'></pre>
		</div>
		<div><button id='control' class="btn btn-primary"></button></div>
	  </div>

	  <div class='tab-pane fade in active' id='2a'>
		<div>
		  <% @records.each do |r| %>
			<%= r.qid %>
			<%= r.correct %>
		  <% end %>
		</div>
	  </div>
  
	  <div class='tab-pane fade' id='3a'>
		<table class='table'>
		  <% @questions.each do |q| %>
		   <tr><td>
			<h4>試題</h4>
			<pre><%= q.prob%></pre>
			<%=image_tag q.attachment%>
			<h4>答案</h4>
			<pre><%= q.ans%></pre>
		   </td></tr>
		  <% end %>
		</table>
	  </div>
	 </div>
	</div>
  </div>
</div>
<script>
$(document).ready(function(){
	//var arr = '<%# Base64.strict_encode64(@questions.to_json(:except => [:created_at, :updated_at])) %>';
	var arr = <%= raw @questions.to_json(:except => [:created_at, :updated_at]) %>;
	//arr = JSON.parse(atob(arr));
	var record = [];
	var now = 0;
	var flag=true;
	show_prob(now);
	$('#control').click(function(){
		if(now == arr.length) send_form();
		if(flag){
			show_ans(now, correct(arr[now].typ, arr[now].ans));
			now += 1;
		}else{
			show_prob(now);
		}
		flag=!flag;
	});
	function correct(type, ans){
		var checked = [];
		$('input:checkbox:checked').each(function(){ checked.push(this.value); });
		switch(type){
			case 1:
				ans = ans.toLowerCase().replace(' ','').split('');
				for(var i in checked)
					if(ans.indexOf(checked[i]) > -1) return true;
				return false;
				break;
			case 2:
				ans = ans.toLowerCase().replace(' ','').split('');
				console.log(checked);
				console.log(ans);
				for(var i in checked)
                    if(ans.indexOf(checked[i]) < 0) return false;
				for(var i in ans)
					if(checked.indexOf(ans[i]) < 0) return false;
				return true;
				break;
			case 3:
				return $('input:text').val() == ans;
				break;
			default:
				return false;
				break;
		}
	}
	function show_ans(now,result){
		$('#show2').show();
		$('#ans').text(arr[now].ans);
		$('#explain').text(arr[now].explain);
		$('#result').text(result ? 'Correct':'False');
		$('#control').text("Next");
		$('input:checkbox').attr('onClick','return false');
		record.push({'qid':arr[now].id, 'correct':result});
	}
	function show_prob(now){
		$('#show2').hide();
		$('input:checkbox').removeAttr('checked onClick');
		$('#explain').text('');
		$('#result').text('');
		$('#prob').text(arr[now].prob);
		$('#img').attr('src',arr[now].attachment.url);
		if(arr[now].typ==3){
			$('#fill').show();
			$('#choice').hide();
		}else{
			$('#fill').hide();
			$('#choice').show();
		}
		$('#control').text("Submit");
	}
	function send_form(){
		$.post({
			url: '/test/record',
			type: 'POST',
			data: { data: JSON.stringify(record),
					id: <%= @test.id %> },
			success: function(r){window.location.reload(true);}
		});
	}
});
</script>
